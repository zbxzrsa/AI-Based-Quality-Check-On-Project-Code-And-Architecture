name: Security Scanning

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    schedule:
        # Run daily at 2 AM
        - cron: "0 2 * * *"

jobs:
    # Static Application Security Testing (SAST)
    sast-python:
        name: SAST - Python (Bandit)
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Install Bandit
              run: pip install bandit[toml]

            - name: Run Bandit Security Scan
              run: |
                  cd backend
                  bandit -r app/ -f json -o bandit-report.json || true
                  bandit -r app/ -f txt

            - name: Upload Bandit Report
              uses: actions/upload-artifact@v3
              if: always()
              with:
                  name: bandit-security-report
                  path: backend/bandit-report.json

    sast-javascript:
        name: SAST - JavaScript/TypeScript (ESLint Security)
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            - name: Install Dependencies
              run: |
                  cd frontend
                  npm ci

            - name: Run ESLint Security Plugin
              run: |
                  cd frontend
                  npm run lint -- --format json --output-file eslint-report.json || true
                  npm run lint

            - name: Upload ESLint Report
              uses: actions/upload-artifact@v3
              if: always()
              with:
                  name: eslint-security-report
                  path: frontend/eslint-report.json

    # Dependency Scanning
    dependency-scan-python:
        name: Dependency Scan - Python (Safety)
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Install Safety
              run: pip install safety

            - name: Run Safety Check
              run: |
                  cd backend
                  pip install -r requirements.txt
                  safety check --json --output safety-report.json || true
                  safety check

            - name: Upload Safety Report
              uses: actions/upload-artifact@v3
              if: always()
              with:
                  name: safety-report
                  path: backend/safety-report.json

    dependency-scan-npm:
        name: Dependency Scan - npm (npm audit)
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            - name: Run npm audit
              run: |
                  cd frontend
                  npm audit --json > npm-audit-report.json || true
                  npm audit

            - name: Upload npm Audit Report
              uses: actions/upload-artifact@v3
              if: always()
              with:
                  name: npm-audit-report
                  path: frontend/npm-audit-report.json

    # Secrets Scanning
    secrets-scan:
        name: Secrets Scanning (TruffleHog)
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Full history for scanning

            - name: TruffleHog OSS
              uses: trufflesecurity/trufflehog@main
              with:
                  path: ./
                  base: ${{ github.event.repository.default_branch }}
                  head: HEAD
                  extra_args: --debug --only-verified

    # Container Scanning
    container-scan:
        name: Container Security Scan (Trivy)
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Build Backend Image
              run: |
                  cd backend
                  docker build -t ai-review-backend:latest .

            - name: Run Trivy  Vulnerability Scanner
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: "ai-review-backend:latest"
                  format: "sarif"
                  output: "trivy-results.sarif"
                  severity: "CRITICAL,HIGH"

            - name: Upload Trivy Results to GitHub Security
              uses: github/codeql-action/upload-sarif@v2
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

    # SAST with CodeQL
    codeql-analysis:
        name: CodeQL Analysis
        runs-on: ubuntu-latest
        permissions:
            security-events: write

        strategy:
            matrix:
                language: ["python", "javascript"]

        steps:
            - uses: actions/checkout@v4

            - name: Initialize CodeQL
              uses: github/codeql-action/init@v2
              with:
                  languages: ${{ matrix.language }}

            - name: Autobuild
              uses: github/codeql-action/autobuild@v2

            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@v2

    # Infrastructure as Code Scanning
    iac-scan:
        name: IaC Security Scan (Checkov)
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Run Checkov
              uses: bridgecrewio/checkov-action@master
              with:
                  directory: .
                  framework: docker_compose
                  output_format: cli,sarif
                  output_file_path: console,checkov-results.sarif

            - name: Upload Checkov Results
              uses: github/codeql-action/upload-sarif@v2
              if: always()
              with:
                  sarif_file: checkov-results.sarif

    # License Compliance
    license-scan:
        name: License Compliance Check
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Install pip-licenses
              run: pip install pip-licenses

            - name: Check Python Licenses
              run: |
                  cd backend
                  pip install -r requirements.txt
                  pip-licenses --format=json --output-file=python-licenses.json
                  pip-licenses

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            - name: Install license-checker
              run: npm install -g license-checker

            - name: Check npm Licenses
              run: |
                  cd frontend
                  npm ci
                  license-checker --json --out npm-licenses.json
                  license-checker

    # Security Report Summary
    security-summary:
        name: Generate Security Report
        needs:
            [
                sast-python,
                sast-javascript,
                dependency-scan-python,
                dependency-scan-npm,
                secrets-scan,
                container-scan,
            ]
        runs-on: ubuntu-latest
        if: always()

        steps:
            - uses: actions/checkout@v4

            - name: Download All Artifacts
              uses: actions/download-artifact@v3

            - name: Generate Summary Report
              run: |
                  echo "# Security Scan Summary" > security-summary.md
                  echo "" >> security-summary.md
                  echo "Scan Date: $(date)" >> security-summary.md
                  echo "" >> security-summary.md
                  echo "## Scans Performed" >> security-summary.md
                  echo "- ✅ Python SAST (Bandit)" >> security-summary.md
                  echo "- ✅ JavaScript SAST (ESLint)" >> security-summary.md
                  echo "- ✅ Python Dependencies (Safety)" >> security-summary.md
                  echo "- ✅ npm Dependencies (npm audit)" >> security-summary.md
                  echo "- ✅ Secrets Scanning (TruffleHog)" >> security-summary.md
                  echo "- ✅ Container Scanning (Trivy)" >> security-summary.md
                  echo "- ✅ CodeQL Analysis" >> security-summary.md
                  echo "- ✅ Infrastructure Scanning (Checkov)" >> security-summary.md

                  cat security-summary.md > $GITHUB_STEP_SUMMARY

            - name: Upload Security Summary
              uses: actions/upload-artifact@v3
              with:
                  name: security-summary
                  path: security-summary.md
