name: Security & Compliance

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  # Critical security checks that must pass - fail fast if any critical issue found
  critical-security:
    name: Critical Security Checks
    runs-on: ubuntu-latest
    outputs:
      critical-failures: ${{ steps.check-failures.outputs.critical-failures }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install Python Security Tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Install Node.js Dependencies
        run: cd frontend && npm ci

      # Critical Check 1: Secrets Detection (MUST PASS)
      - name: TruffleHog Secrets Scan
        id: secrets-scan
        run: |
          echo "ðŸ” Scanning for secrets..."
          # This will fail the job if secrets are found
          docker run --rm -v "$(pwd):/workdir" trufflesecurity/trufflehog:latest \
            git file:///workdir --only-verified --fail

      # Critical Check 2: Python SAST (MUST PASS)
      - name: Bandit SAST Scan
        id: bandit-scan
        run: |
          echo "ðŸ” Running Python SAST..."
          bandit -r backend/app -ll -f json -o bandit-report.json
          bandit -r backend/app -ll

      # Critical Check 3: ESLint Security (MUST PASS)
      - name: ESLint Security Scan
        id: eslint-scan
        run: |
          echo "ðŸ” Running JavaScript/TypeScript SAST..."
          cd frontend && npm run lint

      # Check for critical failures
      - name: Check for Critical Failures
        id: check-failures
        run: |
          critical_failures=0

          # Check if secrets were found (non-zero exit = secrets found)
          if [ "${{ steps.secrets-scan.outcome }}" = "failure" ]; then
            echo "âŒ CRITICAL: Secrets detected in code!"
            critical_failures=$((critical_failures + 1))
          fi

          # Check Bandit results for high/critical issues
          if [ -f bandit-report.json ]; then
            high_issues=$(jq '.results | map(.issues) | flatten | map(select(.issue_confidence == "HIGH" or .issue_severity == "HIGH")) | length' bandit-report.json)
            if [ "$high_issues" -gt 0 ]; then
              echo "âŒ CRITICAL: High-severity security issues found in Python code!"
              critical_failures=$((critical_failures + 1))
            fi
          fi

          echo "critical-failures=$critical_failures" >> $GITHUB_OUTPUT

          if [ "$critical_failures" -gt 0 ]; then
            echo "ðŸš¨ Critical security failures detected. Pipeline will stop."
            exit 1
          else
            echo "âœ… No critical security issues found."
          fi

  # Non-critical security checks (continue on failure)
  dependency-vulnerability-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    needs: critical-security
    if: always() && (needs.critical-security.result == 'success' || needs.critical-security.result == 'failure')

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install Python Dependencies & Safety
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install safety pip-audit

      - name: Install Node.js Dependencies
        run: cd frontend && npm ci

      # Python Dependencies
      - name: Safety Check (Python)
        run: |
          cd backend
          safety check --json --output safety-report.json || true
          safety check || true

      - name: pip-audit Check (Python)
        run: |
          cd backend
          pip-audit --format json --output pip-audit-report.json || true
          pip-audit || true

      # Node.js Dependencies
      - name: npm audit
        run: |
          cd frontend
          npm audit --json > npm-audit-report.json || true
          npm audit --audit-level=moderate || true

      - name: Upload Dependency Reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: dependency-reports
          path: |
            backend/safety-report.json
            backend/pip-audit-report.json
            frontend/npm-audit-report.json

  container-security-scan:
    name: Container & Infrastructure Security
    runs-on: ubuntu-latest
    needs: critical-security
    if: always() && (needs.critical-security.result == 'success' || needs.critical-security.result == 'failure')

    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner for Backend
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'backend'
          format: 'sarif'
          output: 'trivy-backend-results.sarif'

      - name: Run Trivy vulnerability scanner for Frontend
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'frontend'
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'

      - name: Run Checkov (IaC Security)
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: docker_compose
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif

      - name: Upload Security Results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: |
            trivy-backend-results.sarif
            trivy-frontend-results.sarif
            checkov-results.sarif

  codeql-analysis:
    name: CodeQL Advanced Analysis
    runs-on: ubuntu-latest
    needs: critical-security
    if: always() && (needs.critical-security.result == 'success' || needs.critical-security.result == 'failure')
    permissions:
      security-events: write

    strategy:
      matrix:
        language: ["python", "javascript"]

    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    needs: critical-security
    if: always() && (needs.critical-security.result == 'success' || needs.critical-security.result == 'failure')

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install License Checkers
        run: |
          pip install pip-licenses
          npm install -g license-checker

      - name: Check Python Licenses
        run: |
          cd backend
          pip install -r requirements.txt
          pip-licenses --format=json --output-file=python-licenses.json
          pip-licenses

      - name: Check npm Licenses
        run: |
          cd frontend
          npm ci
          license-checker --json --out npm-licenses.json
          license-checker

      - name: Upload License Reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: license-reports
          path: |
            backend/python-licenses.json
            frontend/npm-licenses.json

  # Automated security fixes (only on schedule)
  automated-security-fixes:
    name: Automated Security Fixes
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: [critical-security, dependency-vulnerability-scan]

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Try to fix Python vulnerabilities
        id: python_fix
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
          echo "python_fixes=false" >> $GITHUB_OUTPUT

          # Attempt automated fixes
          pip-audit --fix --require-hashes=false --skip-editable || true

          if git diff backend/requirements*.txt; then
            echo "python_fixes=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Try to fix npm vulnerabilities
        id: npm_fix
        run: |
          cd frontend
          echo "npm_fixes=false" >> $GITHUB_OUTPUT
          npm audit fix || true

          if git diff package*.json; then
            echo "npm_fixes=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Create Pull Request for Security Fixes
        if: steps.python_fix.outputs.python_fixes == 'true' || steps.npm_fix.outputs.npm_fixes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore: automated security dependency updates'
          title: 'ðŸ”’ Security: Automated vulnerability fixes'
          body: |
            ## ðŸ”’ Automated Security Updates

            This PR contains automated fixes for security vulnerabilities detected in dependencies.

            ### Changes Made
            - ${{ steps.python_fix.outputs.python_fixes == 'true' && 'âœ… Python packages updated via pip-audit' || 'âŒ No Python fixes needed' }}
            - ${{ steps.npm_fix.outputs.npm_fixes == 'true' && 'âœ… npm packages updated via npm audit fix' || 'âŒ No npm fixes needed' }}

            ### Verification Required
            - [ ] Run tests locally
            - [ ] Verify no breaking changes
            - [ ] Review updated dependency versions

            **Note:** This is an automated PR created by the security scanning workflow.
          branch: security-updates-${{ github.run_id }}
          delete-branch: true
          labels: 'security,automated,dependencies'

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    if: always()
    needs:
      [
        critical-security,
        dependency-vulnerability-scan,
        container-security-scan,
        codeql-analysis,
        license-compliance
      ]

    steps:
      - uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        if: always()

      - name: Generate Security Summary
        run: |
          echo "# ðŸ”’ Security & Compliance Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "ðŸ“… Scan Date: $(date -u)" >> security-summary.md
          echo "ðŸ”— Commit: ${{ github.sha }}" >> security-summary.md
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}" >> security-summary.md
          echo "" >> security-summary.md

          echo "## ðŸ“Š Scan Results" >> security-summary.md
          echo "" >> security-summary.md

          # Critical Security Status
          if [ "${{ needs.critical-security.result }}" = "success" ]; then
            echo "âœ… **Critical Security Checks**: PASSED" >> security-summary.md
          else
            echo "âŒ **Critical Security Checks**: FAILED" >> security-summary.md
          fi

          # Other scans status
          echo "" >> security-summary.md
          echo "### ðŸ” Security Scans Performed" >> security-summary.md
          echo "- ${{ needs.critical-security.result == 'success' && 'âœ…' || 'âŒ' }} Secrets Detection (TruffleHog)" >> security-summary.md
          echo "- ${{ needs.critical-security.result == 'success' && 'âœ…' || 'âŒ' }} Python SAST (Bandit)" >> security-summary.md
          echo "- ${{ needs.critical-security.result == 'success' && 'âœ…' || 'âŒ' }} JavaScript/TypeScript SAST (ESLint)" >> security-summary.md
          echo "- ${{ needs.dependency-vulnerability-scan.result == 'success' && 'âœ…' || 'âš ï¸' }} Dependency Vulnerabilities" >> security-summary.md
          echo "- ${{ needs.container-security-scan.result == 'success' && 'âœ…' || 'âš ï¸' }} Container Security (Trivy)" >> security-summary.md
          echo "- ${{ needs.container-security-scan.result == 'success' && 'âœ…' || 'âš ï¸' }} IaC Security (Checkov)" >> security-summary.md
          echo "- ${{ needs.codeql-analysis.result == 'success' && 'âœ…' || 'âš ï¸' }} CodeQL Analysis" >> security-summary.md
          echo "- ${{ needs.license-compliance.result == 'success' && 'âœ…' || 'âš ï¸' }} License Compliance" >> security-summary.md

          echo "" >> security-summary.md
          echo "## ðŸ“‹ Next Steps" >> security-summary.md

          if [ "${{ needs.critical-security.result }}" = "failure" ]; then
            echo "### ðŸš¨ Critical Issues Found" >> security-summary.md
            echo "1. **Review and fix critical security issues immediately**" >> security-summary.md
            echo "2. **Do not merge until all critical checks pass**" >> security-summary.md
            echo "3. **Check the security tab for detailed findings**" >> security-summary.md
          else
            echo "### âœ… All Critical Checks Passed" >> security-summary.md
            echo "1. Review any warnings in non-critical scans" >> security-summary.md
            echo "2. Address dependency vulnerabilities if present" >> security-summary.md
            echo "3. Consider the security recommendations in reports" >> security-summary.md
          fi

          echo "" >> security-summary.md
          echo "---" >> security-summary.md
          echo "*Generated by GitHub Actions Security & Compliance workflow*" >> security-summary.md

          cat security-summary.md

      - name: Upload Security Summary
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: security-summary
          path: security-summary.md

      - name: Comment Summary on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
