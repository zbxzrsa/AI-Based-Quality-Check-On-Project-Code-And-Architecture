services:
  # Infrastructure Services
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ai_code_review
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  neo4j:
    image: neo4j:5.15-community
    environment:
      NEO4J_AUTH: neo4j/password
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: apoc.*
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # Application Services
  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - AUTH_SERVICE_URL=http://auth-service:3001
      - CODE_REVIEW_ENGINE_URL=http://code-review-engine:3002
      - ARCHITECTURE_ANALYZER_URL=http://architecture-analyzer:3003
      - AGENTIC_AI_URL=http://agentic-ai:3004
      - PROJECT_MANAGER_URL=http://project-manager:3005
      - JWT_SECRET=your-jwt-secret-key
      - GITHUB_WEBHOOK_SECRET=your-github-webhook-secret
      - CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:3001
      - RATE_LIMIT_WINDOW_MS=900000
      - RATE_LIMIT_MAX=100
      - LOG_LEVEL=info
    depends_on:
      - auth-service
      - code-review-engine
      - architecture-analyzer
      - agentic-ai
      - project-manager
    volumes:
      - ./services/api-gateway/logs:/app/logs
    restart: unless-stopped

  auth-service:
    build:
      context: .
      dockerfile: services/auth-service/Dockerfile
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - PORT=3001
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/ai_code_review
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=your-jwt-secret-key
      - JWT_EXPIRES_IN=24h
      - BCRYPT_ROUNDS=12
      - SESSION_SECRET=your-session-secret
      - SAML_CERT_PATH=/app/certs/saml.crt
      - SAML_KEY_PATH=/app/certs/saml.key
      - OAUTH_CLIENT_ID=your-oauth-client-id
      - OAUTH_CLIENT_SECRET=your-oauth-client-secret
      - LOG_LEVEL=info
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./services/auth-service/logs:/app/logs
      - ./certs:/app/certs:ro
    restart: unless-stopped

  code-review-engine:
    build:
      context: .
      dockerfile: services/code-review-engine/Dockerfile
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=development
      - PORT=3002
      - REDIS_URL=redis://redis:6379
      - GITHUB_ACCESS_TOKEN=your-github-access-token
      - AGENTIC_AI_URL=http://agentic-ai:3004
      - ARCHITECTURE_ANALYZER_URL=http://architecture-analyzer:3003
      - WEBHOOK_PROCESSING_TIMEOUT=30000
      - ANALYSIS_TIMEOUT=300000
      - LOG_LEVEL=info
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./services/code-review-engine/logs:/app/logs
    restart: unless-stopped

  architecture-analyzer:
    build:
      context: .
      dockerfile: services/architecture-analyzer/Dockerfile
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=development
      - PORT=3003
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password
      - REDIS_URL=redis://redis:6379
      - ANALYSIS_TIMEOUT=300000
      - MAX_FILE_SIZE=10485760
      - LOG_LEVEL=info
    depends_on:
      neo4j:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./services/architecture-analyzer/logs:/app/logs
    restart: unless-stopped

  agentic-ai:
    build:
      context: .
      dockerfile: services/agentic-ai/Dockerfile
    ports:
      - "3004:3004"
    environment:
      - NODE_ENV=development
      - PORT=3004
      - OPENAI_API_KEY=your-openai-api-key
      - ANTHROPIC_API_KEY=your-anthropic-api-key
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password
      - REDIS_URL=redis://redis:6379
      - DEFAULT_MODEL=gpt-4
      - MAX_TOKENS=4000
      - TEMPERATURE=0.1
      - REQUEST_TIMEOUT=60000
      - LOG_LEVEL=info
    depends_on:
      neo4j:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./services/agentic-ai/logs:/app/logs
    restart: unless-stopped

  project-manager:
    build:
      context: .
      dockerfile: services/project-manager/Dockerfile
    ports:
      - "3005:3005"
    environment:
      - NODE_ENV=development
      - PORT=3005
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/ai_code_review
      - REDIS_URL=redis://redis:6379
      - TASK_QUEUE_CONCURRENCY=5
      - TASK_RETRY_ATTEMPTS=3
      - TASK_RETRY_DELAY=5000
      - METRICS_RETENTION_DAYS=90
      - LOG_LEVEL=info
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./services/project-manager/logs:/app/logs
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  neo4j_data:
  neo4j_logs:

networks:
  default:
    name: ai-code-review-network